{{define "content"}}
<h2>Project {{.Name}}</h2>
<p>
    Name: {{.Name}}<br/>
    Hash: {{.Hash}}<br/>
    File: {{.File}}<br/>
    Workdir: {{.Workdir}}<br/>
    <button id="start">START</button><br/>
    <button id="stop">STOP</button><br/>
    <button id="restart">RESTART</button><br/>
    <button id="down">DOWN</button><br/>
    <div id="status">CHECKING STATUS</div>
    <br/>
    <div id="log" data-last-line=""></div>
</p>
{{end}}

{{define "scripts"}}
<script>
    let status = "STOPPED";
    let lastText = "";

    document.addEventListener("DOMContentLoaded", function() {
        const socket = new WebSocket("ws://localhost:8080/api/project/logs/{{.Name}}")

        socket.onopen = function () {
            console.log("Connected!");
        }

        socket.onmessage = function (event) {
            log = document.getElementById("log");

            if (lastText !== event.data) {
                log.innerHTML += event.data;
                lastText = event.data
            }
        }
        
        setInterval(() => {
            fetch("/api/project/status/{{.Name}}")
                .then(response => response.json())
                .then(data => {
                    if (data[1] !== '' && status !== "STOPPING") {
                        /* fetchLogs(); */
                        document.getElementById("status").innerHTML = "";
                        let index = 0;
                        data.forEach(function(line) {
                            if (index !== 0 && line.includes("Up")) {
                                status = "RUNNING";
                                document.getElementById("status").innerHTML = "STATUS: " + status + "<br/>";
                            }

                            index++;
                        });
                    } else {
                        status = "STOPPED";
                        document.getElementById("status").innerHTML = "STATUS: " + status;
                        document.getElementById("log").innerHTML = "";
                    }
                })
        }, 1000);

        const start = document.getElementById("start");
        start.addEventListener("click", function() {
            fetch("/api/project/start/{{.Name}}")
                .then(response => response.json())
                .then(data => {
                    status = "STARTING";
                    document.getElementById("status").innerHTML = "STATUS: " + status;
                });
        });

        const stop = document.getElementById("stop");
        stop.addEventListener("click", function() {
            fetch("/api/project/stop/{{.Name}}")
                .then(response => response.json())
                .then(data => {
                    status = "STOPPING";
                    document.getElementById("status").innerHTML = "STATUS: " + status;
                });
        });

        const restart = document.getElementById("restart");
        restart.addEventListener("click", function() {
            fetch("/api/project/restart/{{.Name}}")
                .then(response => response.json())
                .then(data => {
                    status = "RESTARTING";
                    document.getElementById("status").innerHTML = "STATUS: " + status;
                });
        });
    });
</script>
{{end}}
