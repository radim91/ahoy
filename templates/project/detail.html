{{define "content"}}
<h2>Project {{.Name}}</h2>
<p>
    Name: {{.Project.Name}}<br/>
    Hash: {{.Project.Hash}}<br/>
    File: {{.Project.File}}<br/>
    Workdir: {{.Project.Workdir}}<br/>
</p>
<div>
    <button id="start">START</button>
    <button id="stop" class="hidden">STOP</button>
    <button id="restart" class="hidden">RESTART</button>
    <button id="down" class="hidden">DOWN</button>
</div>
<div id="status" class="mt-1">CHECKING STATUS</div>
{{end}}

{{define "scripts"}}
<script>
    const statusElement = document.getElementById("status");
    const start = document.getElementById("start");
    const stop = document.getElementById("stop");
    const restart = document.getElementById("restart");
    const down = document.getElementById("down");
    let status = 'STOPPED';

    document.addEventListener("DOMContentLoaded", function() {
        const socket = new WebSocket("ws://{{.Url}}/api/project/status/{{.Project.Name}}")

        socket.onopen = function () {
            console.log("Connected!");
        }

        socket.onmessage = function (event) {
            const parsedData = JSON.parse(event.data);

            if (parsedData.length === 0 && status === 'STOPPING') {
                status = 'STOPPED';

                stop.classList.toggle("hidden");
                restart.classList.toggle("hidden");
                down.classList.toggle("hidden");
                start.classList.toggle("hidden");
            }

            statusElement.innerHTML = "STATUS: " + status;

            if (parsedData.length > 0 && status !== 'STOPPING') {
                let html = "<table width='100%'><tr><td>Container</td><td>Ports</td><td>Status</td></tr>";

                stop.classList.remove("hidden");
                restart.classList.remove("hidden");
                down.classList.remove("hidden");
                start.classList.add("hidden");

                parsedData.forEach(function(line) {
                    html += `<tr><td><a href="/containers/${line.ID}">${line.Name}</a></td>`;
                    html += `<td>${line.Ports}</td>`;
                    html += `<td>${line.Status}</td></tr>`
                });

                html += "</table>";
                statusElement.innerHTML = html;
            } 
        }

        start.addEventListener("click", function() {
            fetch("/api/project/start/{{.Project.Name}}")
                .then(response => response.json())
                .then(data => {
                    status = 'STARTING';
                });
        });

        stop.addEventListener("click", function() {
            fetch("/api/project/stop/{{.Project.Name}}")
                .then(response => response.json())
                .then(data => {
                    status = 'STOPPING';
                });
        });

        restart.addEventListener("click", function() {
            fetch("/api/project/restart/{{.Project.Name}}")
                .then(response => response.json())
                .then(data => {
                    status = 'RESTARTING';
                });
        });

        down.addEventListener("click", function() {
            fetch("/api/project/down/{{.Project.Name}}")
                .then(response => response.json())
                .then(data => {
                    status = 'DOWN';
                });
        });
    });
</script>
{{end}}
